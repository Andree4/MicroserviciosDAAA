<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Agenda CRUD</title>
  </head>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1,
    h2 {
      text-align: center;
      color: #2c3e50;
    }

    form {
      background-color: #ffffff;
      padding: 20px;
      margin: 20px auto;
      max-width: 700px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    form input,
    form button {
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    form button {
      grid-column: span 2;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    form button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    tr:hover {
      background-color: #f9f9f9;
    }

    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    button.btn-editar {
      background-color: #ffc107;
      color: #212529;
    }

    button.btn-editar:hover {
      background-color: #e0a800;
    }

    button.btn-eliminar {
      background-color: #dc3545;
      color: white;
    }

    button.btn-eliminar:hover {
      background-color: #c82333;
    }

    @media (max-width: 600px) {
      form {
        grid-template-columns: 1fr;
      }

      form button {
        grid-column: span 1;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        background-color: #fff;
      }

      td {
        padding: 8px;
        text-align: right;
        position: relative;
      }

      td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        font-weight: bold;
        text-align: left;
      }
    }
  </style>
  <body>
    <h1>Agenda CRUD</h1>

    <h2>Agregar Contacto</h2>
    <form id="form-agregar">
      <input type="text" name="nombres" placeholder="Nombres" required />
      <input type="text" name="apellidos" placeholder="Apellidos" required />
      <input type="date" name="fecha_nacimiento" required />
      <input type="text" name="direccion" placeholder="Dirección" />
      <input type="text" name="celular" placeholder="Celular" />
      <input type="email" name="correo" placeholder="Correo" />
      <button type="submit">Agregar</button>
    </form>

    <h2>Contactos</h2>
    <table border="1">
      <thead>
        <tr>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Fecha Nacimiento</th>
          <th>Dirección</th>
          <th>Celular</th>
          <th>Correo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-contactos"></tbody>
    </table>

    <script>
      const API_URL = "/api/contactos";
      let contactos = [];

      function toDateInputValue(dateStr) {
        // Convierte ISO/fecha a YYYY-MM-DD para <input type="date">
        const d = new Date(dateStr);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      async function cargarContactos() {
        const res = await fetch(API_URL);
        contactos = await res.json();
        renderTabla();
      }

      function renderTabla() {
        const tbody = document.getElementById("tabla-contactos");
        tbody.innerHTML = "";
        contactos.forEach((c) => {
          const tr = document.createElement("tr");
          tr.id = `row-${c._id}`;
          tr.innerHTML = `
          <td>${c.nombres || ""}</td>
          <td>${c.apellidos || ""}</td>
          <td>${new Date(c.fecha_nacimiento).toLocaleDateString()}</td>
          <td>${c.direccion || ""}</td>
          <td>${c.celular || ""}</td>
          <td>${c.correo || ""}</td>
          <td>
            <button data-id="${c._id}" class="btn-editar">Editar</button>
            <button onclick="eliminarContacto('${c._id}')">Eliminar</button>
          </td>
        `;
          tbody.appendChild(tr);
        });

        // Delegar eventos de editar
        document.querySelectorAll(".btn-editar").forEach((b) => {
          b.addEventListener("click", () =>
            iniciarEdicion(b.getAttribute("data-id"))
          );
        });
      }

      function iniciarEdicion(id) {
        const c = contactos.find((x) => x._id === id);
        if (!c) return;

        const tr = document.getElementById(`row-${id}`);
        tr.innerHTML = `
        <td><input id="e-nombres-${id}" type="text" value="${
          c.nombres || ""
        }" required></td>
        <td><input id="e-apellidos-${id}" type="text" value="${
          c.apellidos || ""
        }" required></td>
        <td><input id="e-fecha-${id}" type="date" value="${toDateInputValue(
          c.fecha_nacimiento
        )}" required></td>
        <td><input id="e-direccion-${id}" type="text" value="${
          c.direccion || ""
        }"></td>
        <td><input id="e-celular-${id}" type="text" value="${
          c.celular || ""
        }"></td>
        <td><input id="e-correo-${id}" type="email" value="${
          c.correo || ""
        }"></td>
        <td>
          <button onclick="guardarEdicion('${id}')">Guardar</button>
          <button onclick="cancelarEdicion()">Cancelar</button>
        </td>
      `;
      }

      async function guardarEdicion(id) {
        const payload = {
          nombres: document.getElementById(`e-nombres-${id}`).value.trim(),
          apellidos: document.getElementById(`e-apellidos-${id}`).value.trim(),
          fecha_nacimiento: document.getElementById(`e-fecha-${id}`).value,
          direccion: document.getElementById(`e-direccion-${id}`).value.trim(),
          celular: document.getElementById(`e-celular-${id}`).value.trim(),
          correo: document.getElementById(`e-correo-${id}`).value.trim(),
        };

        try {
          const resp = await fetch(`${API_URL}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            alert("Error al actualizar: " + (err.message || resp.status));
            return;
          }
          const actualizado = await resp.json();
          // Actualiza en memoria y re-renderiza
          const idx = contactos.findIndex((x) => x._id === id);
          if (idx !== -1) contactos[idx] = actualizado;
          renderTabla();
        } catch (e) {
          alert("Error de red al actualizar");
        }
      }

      function cancelarEdicion() {
        renderTabla();
      }

      // Agregar contacto
      document
        .getElementById("form-agregar")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const datos = Object.fromEntries(formData);
          try {
            const resp = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(datos),
            });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({}));
              alert("Error al crear: " + (err.message || resp.status));
              return;
            }
            e.target.reset();
            cargarContactos();
          } catch (err) {
            alert("Error de red al crear");
          }
        });

      // Eliminar
      async function eliminarContacto(id) {
        if (!confirm("¿Eliminar contacto?")) return;
        try {
          await fetch(`${API_URL}/${id}`, { method: "DELETE" });
          contactos = contactos.filter((c) => c._id !== id);
          renderTabla();
        } catch (e) {
          alert("Error de red al eliminar");
        }
      }

      // Inicializar
      cargarContactos();
    </script>
  </body>
</html>
